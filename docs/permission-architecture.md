# 多项目协作权限架构方案（逻辑分离版）

## 1. 目标
- 支持多个项目经理并行管理各自项目，数据默认按“项目授权”隔离。
- 保留统一登录与统一 API，先做逻辑分离（用户平台 / 管理平台），再逐步物理分离。
- 为 Chatbot、审计、飞书同步统一接入同一套访问控制规则。

## 2. 权限模型

### 2.1 全局角色（User.role）
- `super_admin`：全局最高权限，可管理所有用户、项目和授权关系。
- `project_director`：项目总监，拥有其可访问项目的管理权限，可管理中低权限成员。
- `project_manager`：项目经理，负责项目执行与日常维护。
- `viewer`：只读查看。
- 兼容旧角色：`lead` 视作 `project_director`，`pm` 视作 `project_manager`。

### 2.2 项目级角色（ProjectMembership.role）
- `director` / `manager` / `member` / `viewer`。
- 一个用户可绑定多个项目（多对多）。
- 数据访问范围 = 本人拥有项目 + 项目成员授权项目。

## 3. 平台逻辑分离

### 3.1 用户平台（workspace）
- 面向项目执行：总览、需求、成本、进度、风险、资源、AI、飞书、通知、PM 助手等。
- 默认按项目范围隔离数据。

### 3.2 管理平台（admin）
- 面向管理运维：用户角色管理、项目授权管理、审计、系统设置。
- 仅 `super_admin / project_director`（兼容 `lead`）可进入。

## 4. 后端控制策略
- 控制层：`Roles` + `RolesGuard` 做角色准入。
- 资源层：`AccessService` 做项目范围过滤与写入校验。
- AI 层：ReAct 工具调用必须继承同一访问范围，禁止越权读写。
- 审计层：记录模型推理路径、工具调用、输入输出和结果状态。

## 5. 安全与审计
- 每次 Chatbot 操作写入审计日志，含 trace 与 toolCalls。
- 操作结果需区分“查询成功”和“写入成功”，避免“口头成功”但未落库。
- 管理平台所有高风险操作（角色变更、授权变更）保留日志。

## 6. 迁移与兼容
- 新增 `ProjectMembership` 表与 `ProjectRole` 枚举。
- 旧角色不强制一次性迁移，先通过服务层归一化兼容。
- 后续再做数据清洗，将 `pm/lead` 逐步收敛到新角色枚举。
